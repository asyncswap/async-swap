<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Home</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/asyncswap/async-swap" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="async-swap-amm"><a class="header" href="#async-swap-amm">Async Swap AMM</a></h1>
<p>We use Uniswap V4â€™s hook to implement a new batch-auction style MEV-resilient mechanism for AMM. Our approach expands the recent theoretical work of https://dl.acm.org/doi/10.1145/3564246.3585233, and mitigates MEVs by imposing a specific transaction ordering rule so that transactions in different directions (buy or sell) are matched as much as possible. A technical challenge in our hook implementation is that we need to impose constraints (the transaction ordering rule) on the block level instead of individual transaction levels. Our MEV-resilient Asyn Swap AMM has a nice property in that an MEV-maximizing builder will order transactions in such a way that no MEV opportunities remain.</p>
<p>Batch auctions have been advocated for preventing manipulative behaviors either in traditional limit-order markets (e.g., Budish, Crampton, and Shin 2015 against HFT rat race) or on AMMs (e.g., Ferreira and Parks 2023 against MEV). In this project, we demonstrate how Uniswap V4 hooks can implement batch auctions natively on constant-product AMMs. We overcome the technical challenge in our hook implementation in that we need to impose constraints (the transaction ordering rule) on the block level instead of individual transaction levels. Our resulting MEV-resilient AMM has a nice property in that an MEV-maximizing builder will order transactions in such a way that no MEV opportunities remain.</p>
<ul>
<li><a href="https://github.com/classcool/async-swap/blob/main/src/AsyncCSMM.sol">AsyncCSMM - hook contract</a></li>
<li><a href="https://github.com/classcool/async-swap/blob/main/src/router.sol">Router - add liquidity, swap &amp; fill async orders</a></li>
<li><a href="https://frontend-mu-one-27.vercel.app/">Live Demo Frontend</a></li>
<li><a href="https://www.loom.com/share/b66cfb28f41b452c8cb6debceea35631?sid=962ac2ae-c2d4-49ff-b621-b99428b44ff9">Video Walkthrough</a></li>
<li><a href="https://www.loom.com/share/15839f36efaf42e48642b5f1269c6709?sid=ab37fb1b-a31a-4519-9973-d34a7777360f">Transaction Ordering rules walkthorugh video</a></li>
</ul>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<p>To install dependencies in all our packages in <code>packages/*</code></p>
<pre><code class="language-bash">bun install
</code></pre>
<p>Install foundry dependencies (v4-periphery)</p>
<pre><code class="language-sh">forge install
</code></pre>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<blockquote>
<p>[!TIP]
We suggest you set up local anvil account with cast.</p>
<pre><code class="language-sh">cast wallet import --mnemonic "test test test test test test test test test test test junk" anvil
</code></pre>
<ul>
<li>This will allow you to use <code>--account anvil</code> in the deploys scripts in <a href="./dev/start_script.sh"><code>.dev/start_script.sh</code></a></li>
</ul>
</blockquote>
<p>Run local anvil node</p>
<pre><code class="language-sh">anvil
# or simulate block mining and finality
anvil --block-time 13
</code></pre>
<h2 id="local-deployment"><a class="header" href="#local-deployment">Local Deployment</a></h2>
<p>Run deployment script</p>
<pre><code class="language-sh">./dev/start_script.sh # scripts that you use --account setup of you choice
</code></pre>
<blockquote>
<p>[!NOTE]</p>
<p>The start scripts will do the following:</p>
<ol>
<li>Deploy local PoolManger <a href="./script/00_DeployPoolManager.s.sol"><code>./script/00_DeployPoolManager.s.sol</code></a></li>
<li>Deploy Hook &amp; Router contracts <a href="./script/01_DeployHook.s.sol"><code>./script/01_DeployHook.s.sol</code></a></li>
<li>Initialize a pool with your hook attached <a href="./script/02_InitilizePool.s.sol"><code>./script/02_InitilizePool.s.sol</code></a></li>
<li>Add liqudity to previously initialized pool <a href="./script/03_AddLiquidity.s.sol"><code>./script/03_AddLiquidity.s.sol</code></a></li>
<li>Submit an async swap transaction through custom router <a href="./script/04_Swap.s.sol"><code>./script/04_Swap.s.sol</code></a></li>
<li>Fill previously submitted swap transaction <a href="./script/05_ExecuteOrder.s.sol"><code>./script/05_ExecuteOrder.s.sol</code></a></li>
</ol>
</blockquote>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>Run tests</p>
<pre><code class="language-sh">forge test -vvvv
</code></pre>
<h2 id="offchain-indexer"><a class="header" href="#offchain-indexer">Offchain Indexer</a></h2>
<p>Start local indexer</p>
<pre><code class="language-sh">bun run dev
</code></pre>
<blockquote>
<p>[!Tip]</p>
<ul>
<li>If you need typescript abi for your contracts on frontend or indexer use this script <a href="./dev/generateAbi.sh"><code>./dev/generateAbi.sh</code></a></li>
</ul>
<pre><code class="language-sh">./dev/generateAbi.sh
</code></pre>
</blockquote>
<p>Go to <a href="http://localhost:42069">http://localhost:42069</a> to query orders from hook events</p>
<h2 id="docs"><a class="header" href="#docs">Docs</a></h2>
<p>View documentation:</p>
<pre><code class="language-sh">forge doc --serve --port 4000 --watch

</code></pre>
<h2 id="acknowledgment"><a class="header" href="#acknowledgment">Acknowledgment</a></h2>
<p>Thanks to <a href="https://atrium.academy">Atrium Academy</a>, over the past 2 months we build this project during Uniswap Hook incubator program.</p>
<p>Team Socials:</p>
<ul>
<li>Meek <a href="https://x.com/msakiart">X</a>, <a href="https://github.com/mmsaki">github</a></li>
<li>Jiasun Li <a href="https://x.com/mysteryfigure">X</a>, <a href="https://github.com/mysteryfigure">github</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next prefetch" href="src/algorithms/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next prefetch" href="src/algorithms/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="solidity.min.js"></script>


    </div>
    </body>
</html>
